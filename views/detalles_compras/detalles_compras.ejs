<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="shortcut icon" href="#" />
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>DataTables estilo Bootstrap 5 - NodeJS y Express</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/css/bootstrap.min.css"
    integrity="sha384-DhY6onE6f3zzKbjUPRc2hOzGAdEf4/Dz+WJwBvEYL/lkkIsI3ihufq9hk9K4lVoK" crossorigin="anonymous" />
  <link rel="icon" href="resources/images/fevicon.png" type="image/png" />
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap5.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.2/dist/sweetalert2.min.css" />
  <style>
    table.dataTable thead {
      background-color: #485464;
    color: white;
    }
 
    .ftable{
      background-color: rgba(224, 223, 223, 0.433);
      color: rgb(0, 0, 0);
    }
    .btn-group img {
    max-width: 24px; /* Define el ancho máximo del icono */
    max-height: 24px; /* Define el alto máximo del icono */
    }
    body{
      background-color: #00000000;
    }
  </style>
</head>
<body>
    <div class="container-fluid">
      <h1 id="tituloImpresion" class="" style="
        text-align: left;
        font-family: Arial,sans-serif;
        font-size: 25px;
        padding: 20px 0;
        background-color: #485464; 
        color: #ffffff;">&nbsp;&nbsp;&nbsp;&nbsp;Tablero de control - Detalles de Compra</h1>

      <a id="btnActualizar" class="btn btn-group btn-light mt-2" style="font-size: 20px;">
        <img src="resources/images/iconos/refresh.svg" alt="Crear"> &nbsp;Actualizar
      </a>
  
      <a id="btnExportar" class="btn btn-group btn-light mt-2" style="font-size: 20px;">
        <img src="resources/images/iconos/export.svg" alt="Crear"> &nbsp;Exportar CSV 
      </a>

      <!-- Contenedor de la tabla de detalles de compra -->
      <div class="row shadow-lg p-3 mb-5 ftable" id="detallesCompraContainer">
        <div class="col">
          <table id="tablaDetallesCompra" class="table table-striped table-bordered" style="width: 100%">
            <thead>
              <tr>
                <th class="text-center">ID Detalle Compra</th>
                <th class="text-center">ID Compra</th>
                <th class="text-center">ID Producto</th>
                <th class="text-center">Cantidad de Empaque</th>
                <th class="text-center">Cantidad Unitaria</th>
                <th class="text-center">Fecha de Vencimiento</th>
                <th class="text-center">Precio Unitario</th>
                <th class="text-center">ID Unidad de Empaque</th>
                <th class="text-center" style="width: 150px;">ACCIONES</th>
              </tr>
            </thead>
            <tbody>
              <% results.forEach(function(detalleCompra) { %>
                <tr>
                  <td class="text-center"><%= detalleCompra.ID_Detalle_Compra %></td>
                  <td class="text-center"><%= detalleCompra.ID_Compra %></td>
                  <td class="text-center"><%= detalleCompra.ID_Producto %></td>
                  <td class="text-center"><%= detalleCompra.Cantidad_Empaque %></td>
                  <td class="text-center"><%= detalleCompra.Cantidad_Unitario %></td>
                  <td class="text-center"><%= detalleCompra.Fecha_Vencimiento %></td>
                  <td class="text-center"><%= detalleCompra.Precio_Unitario %></td>
                  <td class="text-center"><%= detalleCompra.ID_Unidad_Empaque %></td>
                  <td>
                    <div class="text-center">
                      <div class="btn-group">
                        <a href="#" class="btn btn-sm btnBorrar"><img src="resources/images/iconos/delete.svg" alt="Eliminar"></a>
                        <a href="#" class="btn btn-sm btnCopiar"><img src="resources/images/iconos/copy.svg" alt="Copiar"></a>
                      </div>
                    </div>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  
    <!-- Modal para CRUD -->
    <div id="modalCRUD" class="modal fade" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel"></h5>
          </div>
          <form id="formDetallesCompra">
            <div class="modal-body">
              <input type="text" class="form-control" id="ID_Detalle_Compra" hidden />
              <label for="ID_Compra" class="col-form-label">ID Compra</label>
              <input type="number" class="form-control" id="ID_Compra" />
              <label for="ID_Producto" class="col-form-label">ID Producto</label>
              <input type="number" class="form-control" id="ID_Producto" />
              <label for="Cantidad_Empaque" class="col-form-label">Cantidad de Empaque</label>
              <input type="number" class="form-control" id="Cantidad_Empaque" />
              <label for="Cantidad_Unitario" class="col-form-label">Cantidad Unitaria</label>
              <input type="number" class="form-control" id="Cantidad_Unitario" />
              <label for="Fecha_Vencimiento" class="col-form-label">Fecha de Vencimiento</label>
              <input type="date" class="form-control" id="Fecha_Vencimiento" />
              <label for="Precio_Unitario" class="col-form-label">Precio Unitario</label>
              <input type="number" class="form-control" id="Precio_Unitario" />
              <label for="ID_Unidad_Empaque" class="col-form-label">ID Unidad de Empaque</label>
              <input type="number" class="form-control" id="ID_Unidad_Empaque" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
              <button type="submit" id="btnGuardar" class="btn" style="background-color: #28A787; color: white; ">
                Guardar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  <!-- Tus scripts de JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/js/bootstrap.min.js"
    integrity="sha384-5h4UG+6GOuV9qXh6HqOLwZMY4mnLPraeTrjT5v07o347pj6IkfuoASuGBhfDsp3d"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.2/dist/sweetalert2.all.min.js"></script>
  <script type="text/javascript" language="javascript"
    src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" language="javascript"
    src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>

  <script>
$(document).ready(function () {
    let url = "/detalles_compras/"; // Define la variable url aquí
    let opcion = null;
    let ID_Detalle_Compra, ID_Compra, ID_Producto, Cantidad_Empaque, Cantidad_Unitario, Fecha_Vencimiento, Precio_Unitario, ID_Unidad_Empaque;

    let tablaDetallesCompra = $("#tablaDetallesCompra").DataTable({
        JSON: {
            url: url,
            dataSrc: "",
        },
        columns: [
            { data: "ID_Detalle_Compra" },
            { data: "ID_Compra" },
            { data: "ID_Producto" },
            { data: "Cantidad_Empaque" },
            { data: "Cantidad_Unitario" },
            { 
              data: "Fecha_Vencimiento",
              render: function(data, type, row) {
                  if (type === 'display' || type === 'filter') {
                      if (data) {
                          let fechaSinProcesar = new Date(data);
                          let dia = fechaSinProcesar.getDate();
                          let mes = fechaSinProcesar.getMonth() + 1;
                          let año = fechaSinProcesar.getFullYear();
                          return `${dia}- ${mes}- ${año}`;
                      } else {
                          return '';
                      }
                  } else {
                      return data;
                  }
              }
          },
            { data: "Precio_Unitario" },
            { data: "ID_Unidad_Empaque" },
            {
                defaultContent:
                    "<div class='text-center'><div class='btn-group'><button class='btn btn-info btn-sm btnEditar'>Editar</button><button class='btn btn-danger btn-sm btnBorrar'>Borrar</button></div></div>",
            },
        ],
        language: {
                    url: "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json",
                },
    });

    // Evento click para el botón de eliminar
    $("#tablaDetallesCompra").on("click", ".btnBorrar", function () {
        var data = tablaDetallesCompra.row($(this).parents("tr")).data(); // Obtener datos de la fila
        var id = data.ID_Detalle_Compra;
        opcion = "eliminar"; // Establecer la opción como eliminar
        Swal.fire({
            title: "¿Estás seguro?",
            text: "¡No podrás revertir esto!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Sí, eliminarlo!",
        }).then((result) => {
            if (result.isConfirmed) {
                // Hacer la petición para eliminar
                $.ajax({
                    type: "POST",
                    url: url + id,
                    data: { opcion: opcion },
                    success: function (data) {
                        Swal.fire(
                            "¡Eliminado!",
                            "El registro ha sido eliminado.",
                            "success"
                        ).then((result) => {
                            if (result.isConfirmed) {
                                window.location.reload(); // Recarga la página si se confirma la acción
                            }
                        });
                    },
                });
            }
        });
    });

    // Evento click para el botón de editar
    $("#tablaDetallesCompra").on("click", ".btnEditar", function () {
        var data = tablaDetallesCompra.row($(this).parents("tr")).data();
        $("#exampleModalLabel").text("Editar Detalle de Compra");

        // Llenar los campos del formulario
        $("#ID_Detalle_Compra").val(data.ID_Detalle_Compra);
        $("#ID_Compra").val(data.ID_Compra);
        $("#ID_Producto").val(data.ID_Producto);
        $("#Cantidad_Empaque").val(data.Cantidad_Empaque);
        $("#Cantidad_Unitario").val(data.Cantidad_Unitario);
        $("#Fecha_Vencimiento").val(data.Fecha_Vencimiento);
        $("#Precio_Unitario").val(data.Precio_Unitario);
        $("#ID_Unidad_Empaque").val(data.ID_Unidad_Empaque);

        // Mostrar el modal
        $("#modalCRUD").modal("show");

        opcion = "editar";
    });

    // Manejo del formulario para crear o editar detalles de compra
    $("#formDetallesCompra").submit(function (e) {
        e.preventDefault();

        var formData = {
            ID_Detalle_Compra: $("#ID_Detalle_Compra").val(),
            ID_Compra: $("#ID_Compra").val(),
            ID_Producto: $("#ID_Producto").val(),
            Cantidad_Empaque: $("#Cantidad_Empaque").val(),
            Cantidad_Unitario: $("#Cantidad_Unitario").val(),
            Fecha_Vencimiento: $("#Fecha_Vencimiento").val(),
            Precio_Unitario: $("#Precio_Unitario").val(),
            ID_Unidad_Empaque: $("#ID_Unidad_Empaque").val(),
            opcion: opcion,
        };

        $.ajax({
            type: "POST",
            url: url + formData.ID_Detalle_Compra,
            data: formData,
            success: function (data) {
                $("#modalCRUD").modal("hide");
                window.location.reload();
            },
            error: function (err) {
                console.error("Error al editar detalle de compra:", err);
            },
        });
    });

    // Botón para crear un nuevo registro
    $("#btnCrear").click(function () {
        // Limpiar los campos del formulario
        $("#ID_Detalle_Compra").val("");
        $("#ID_Compra").val("");
        $("#ID_Producto").val("");
        $("#Cantidad_Empaque").val("");
        $("#Cantidad_Unitario").val("");
        $("#Fecha_Vencimiento").val("");
        $("#Precio_Unitario").val("");
        $("#ID_Unidad_Empaque").val("");
        $("#exampleModalLabel").text("Crear Detalle de Compra");
        $("#modalCRUD").modal("show");
        opcion = "crear";
    });

    //#region boton actualizar
    $("#btnActualizar").click(function () {
        // Recarga la página actual
        location.reload();
    });

    //#endregion

    // Botón para exportar
    $("#btnExportar").click(function () {
        // Crear un nuevo libro de Excel
        var wb = XLSX.utils.book_new();

        // Obtener los datos de la tabla excluyendo la columna de acciones
        var wsData = [];
        $("#tablaDetallesCompra tbody tr").each(function () {
            var rowData = [];
            $(this)
                .find("td")
                .each(function () {
                    rowData.push($(this).text().trim());
                });
            wsData.push(rowData);
        });

        // Crear una hoja de trabajo con los datos obtenidos
        var ws = XLSX.utils.aoa_to_sheet([
            [
                "ID_Detalle_Compra",
                "ID_Compra",
                "ID_Producto",
                "Cantidad_Empaque",
                "Cantidad_Unitario",
                "Fecha_Vencimiento",
                "Precio_Unitario",
                "ID_Unidad_Empaque",
            ],
        ].concat(wsData));

        // Agregar la hoja de trabajo al libro
        XLSX.utils.book_append_sheet(wb, ws, "Detalles_Compra");

        // Guardar el libro como un archivo Excel
        XLSX.writeFile(wb, "detalles_compra.xlsx");
    });

    // Botón para imprimir PDF
    $("#btnImprimir").click(function () {
        printTable();
    });

    // Evento click para el botón de copiar
    $("#tablaDetallesCompra").on("click", ".btnCopiar", function () {
        // Obtener la fila correspondiente al botón de copiar
        var fila = $(this).closest("tr");

        // Obtener los datos de la fila
        var datosFila = fila.find("td").map(function () {
            return $(this).text();
        }).get();

        // Convertir los datos en una cadena separada por tabulaciones
        var datosCopiar = datosFila.join("\t");

        // Copiar los datos al portapapeles
        navigator.clipboard.writeText(datosCopiar).then(function () {
            console.log("Datos copiados al portapapeles:", datosCopiar);
            // Mostrar un mensaje de éxito
            alert("¡Datos copiados al portapapeles!");
        }).catch(function (error) {
            console.error("Error al copiar datos al portapapeles:", error);
            // Mostrar un mensaje de error si es necesario
            alert("Error al copiar datos al portapapeles");
        });
    });
});

  </script>
  
</body>

</html>
